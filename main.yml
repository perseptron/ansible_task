---
- hosts: db
  vars:
    db_host: 172.17.0.3
    db_name: laravel
    db_user: mandrake
    db_pass: dewq321

  remote_user: mandrake
  become: yes
  tasks:
  - name: "Install from repo"
    apt:
      update_cache: yes
      pkg:
      - mariadb-server
      - python3-pymysql

#    notify:
#      - Start mariadb
#  - name: "Start mariadb service"
#    systemd:
#      name: mariadb
#      state: started
#      enabled: yes


  - name: "Add user"
    mysql_user:
      name: "{{ db_user }}"
      password: "{{ db_pass }}"
      priv: '*.*:ALL'
      state: present
      login_unix_socket: /var/run/mysqld/mysqld.sock

  - name: "Add database"
    mysql_db:
      name: "{{ db_name }}"
      state: present
      login_user: "{{ db_user }}"
      login_password: "{{ db_pass }}"
    register: db_ready

  handlers:
   - name: Start mariadb
     service:
       name: mariadb
       state: started

- hosts: server
  remote_user: mandrake
  become: yes
  tasks:
  - name: "check var"
    debug:
      var: db_host

  - name: "Install from repo"
    apt:
      update_cache: yes
      pkg:
      -  mc
      -  iputils-ping
      -  gpg
      -  git
      -  php8.1
      -  php-xml
      -  php-mysql
      -  php-curl
      -  apache2

#  - name: "Start Apache"
#    service:
#     name: apache2
#     state: started

  - name: "download composer"
    ansible.builtin.get_url:
      url: https://getcomposer.org/download/latest-stable/composer.phar
      dest: /usr/local/bin/composer
      mode: '777'

  - name: "Add nodejs apt key"
    apt_key:
      url: https://deb.nodesource.com/gpgkey/nodesource.gpg.key
      state: present

  - name: "Add nodejs lts.x ppa for apt repo"
    apt_repository:
      repo: deb https://deb.nodesource.com/node_20.x jammy main
      update_cache: yes

  - name: "Install nodejs"
    apt:
      update_cache: yes
      name: nodejs
      state: present

  - name: "Check app exists"
    stat:
      path: /var/www/app
    register: app

  - name: "Remove old app"
    when: app.stat.exists
    file:
      path: /var/www/app
      state: absent

  - name: "Get app"
    git:
      repo: https://github.com/Practical-DevOps/app-for-devops.git
      dest: /var/www/app

  - name: "Change ownership"
    file:
      dest: /var/www/app
      owner: root
      group: www-data
      mode: 0775
      recurse: yes
  - name: "Change www root"
    replace:
      path: /etc/apache2/sites-available/000-default.conf
      regexp: '^DocumentRoot /var/www/html$'
      replace: 'DocumentRoot /var/www/app/public'
  - name: "rename env"
    command: mv /var/www/app/.env.example /var/www/app/.env

  - name: "install app dependency"
    composer:
      command: update
      working_dir: /var/www/app

  - name: "Set app key"
    shell: php /var/www/app/artisan key:generate

  - name: "check vars"
    shell: echo $db_host

  - name: "npm istall (move down)"
    npm:
      path: /var/www/app

  - name: "npm run (move down)"
    command: npm run build
    args:
      chdir: /var/www/app

  - name: "Migrate database"
    environment:
      DB_HOST: "{{ db_host }}"
      DB_USERNAME: "{{ db_user }}"
      DB_PASSWORD: "{{ db_pass }}"
    shell: php /var/www/app/artisan migrate
